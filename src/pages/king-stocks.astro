---
import BaseLayout from '../layouts/BaseLayout.astro';
import fs from "fs";
import path from "path";
import Tabs from "../components/Tabs.astro";
import Pagination from "../components/Pagination.astro";
import Overview from "../components/Overview.astro";
import Dividends from "../components/Dividends.astro";
import Financials from "../components/Financials.astro";

let stocks = [];
let error: string | null = null;

const __dirname = path.resolve();

try {
  const STOCKS_DIR = path.resolve(path.basename(__dirname), "../../data/stocks");
  console.log(STOCKS_DIR)
  // const STOCKS_DIR = path.resolve("~/data/stocks");
  const files = fs.readdirSync(STOCKS_DIR).filter(f => f.endsWith(".json"));
  stocks = files.map(file => JSON.parse(fs.readFileSync(path.join(STOCKS_DIR, file), "utf-8")));
} catch (err: any) {
  error = err.message;
}

const tabs = [
  { id: "overview", label: "Overview" },
  { id: "dividends", label: "Dividends" },
  { id: "financials", label: "Financials" },
];
---

<BaseLayout title="Dividend King Stocks â€” Future Dividend">
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const rowsPerPage = 15;
      let currentPage = 1;

      function renderPage(page) {
        const activeTable = document.querySelector("[data-view]:not([style*='display: none']) table");
        if (!activeTable) return;
        const rows = Array.from(activeTable.querySelectorAll("tbody tr"));
        const totalPages = Math.ceil(rows.length / rowsPerPage);

        rows.forEach((row, idx) => {
          row.style.display =
            idx >= (page - 1) * rowsPerPage && idx < page * rowsPerPage
              ? ""
              : "none";
        });

        document.getElementById("page-indicator").textContent =
          `Page ${page} / ${totalPages}`;
        currentPage = page;
      }

      // Tab switching
      document.querySelectorAll("[data-tab]").forEach(btn => {
        btn.addEventListener("click", () => {
          const tab = btn.dataset.tab;
          document.querySelectorAll("[data-view]").forEach(view => {
            view.style.display = view.dataset.view === tab ? "" : "none";
          });
          renderPage(currentPage);
        });
      });

      document.getElementById("prev-btn").addEventListener("click", () => {
        if (currentPage > 1) renderPage(currentPage - 1);
      });
      document.getElementById("next-btn").addEventListener("click", () => {
        const activeTable = document.querySelector("[data-view]:not([style*='display: none']) table");
        if (!activeTable) return;
        const rows = activeTable.querySelectorAll("tbody tr").length;
        const totalPages = Math.ceil(rows / rowsPerPage);
        if (currentPage < totalPages) renderPage(currentPage + 1);
      });

      renderPage(currentPage);
    });

    document.addEventListener("tabChange", (e) => {
      const tab = e.detail.tab;
      document.querySelectorAll("[data-view]").forEach(view => {
        view.style.display = view.dataset.view === tab ? "" : "none";
      });
      setTimeout(() => renderPage(currentPage), 0);
    });
  </script>

  <body class="bg-gray-50 p-6 font-sans text-sm text-gray-800">
    <div class="max-w-7xl mx-auto">
      <h1 class="text-lg font-bold mb-4">Dividend King Stocks</h1>

      <Tabs tabs={tabs} active="overview" />

      {error ? (
        <div class="bg-red-100 text-red-700 p-3 rounded mb-4">Error loading data: {error}</div>
      ) : (
        <div class="overflow-x-auto border border-gray-200 rounded-lg shadow-sm bg-white">
          <div data-view="overview"><Overview stocks={stocks} /></div>
          <div data-view="dividends" style="display:none"><Dividends stocks={stocks} /></div>
          <div data-view="financials" style="display:none"><Financials stocks={stocks} /></div>
        </div>
      )}

      <Pagination />
    </div>
  </body>
</BaseLayout>
